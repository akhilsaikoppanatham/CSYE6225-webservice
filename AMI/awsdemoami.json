{
  "builders": [
    {
      "type": "amazon-ebs",
      "access_key": "{{user `aws_access_key`}}",
      "secret_key": "{{user `aws_secret_key`}}",
      "region": "us-east-1",
      "source_ami": "ami-0c293f3f676ec4f90",
      "instance_type": "t2.micro",
      "ssh_username": "ec2-user",
      "ami_name": "csye6225_{{timestamp}}",
      "ami_users": "876375802417",
      "ami_description": "Amazon Linux 2 AMI for CSYE_6225",
      "launch_block_device_mappings": [
        {
          "device_name": "/dev/xvda",
          "volume_size": 20,
          "volume_type": "gp2",
          "delete_on_termination": true
        }
      ],
      "tags": {
        "Name": "csye6225 - {{timestamp}}"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [ "mkdir /tmp/webservice" ]
    },
    {
      "type": "file",
      "source": "./",
      "destination": "/tmp/webservice/"
    },
    {
      "type": "shell",
      "inline": [
        "sudo yum update -y",
        "sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022",
        "sudo rpm -Uvh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm",
        "sudo yum install mysql-community-server -y",
        "sudo systemctl start mysqld.service",
        "pwd=`sudo grep 'temporary password' /var/log/mysqld.log | rev | cut -d':' -f 1 | rev | xargs`",
        "sudo mysql -uroot -p$pwd --connect-expired-password -e \"Alter user 'root'@'localhost' IDENTIFIED BY 'Qwerty@123!';\"",
        "sleep 10",
        "echo Install Node.js",
        "sudo curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash",
        ". ~/.nvm/nvm.sh",
        "nvm install node",
        "node --version",
        "mkdir -p ~/webservice",
        "mv /tmp/webservice/* ~/webservice/",
        "cd ~/webservice",
        "pwd",
        "npm install"
      ]
    }
  ]
}
